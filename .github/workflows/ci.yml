# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# RunWatch CI Pipeline
# Runs on every push/PR to main ‚Äî build, lint, test, security
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  NODE_VERSION: '18'

jobs:
  # ‚îÄ‚îÄ Detect Changes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    outputs:
      client: ${{ steps.filter.outputs.client }}
      server: ${{ steps.filter.outputs.server }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            client:
              - 'client/**'
              - 'package.json'
            server:
              - 'server/**'
              - 'package.json'
            docker:
              - '**/Dockerfile'
              - 'docker-compose.yml'

  # ‚îÄ‚îÄ Client Pipeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  client-build:
    name: üñ•Ô∏è Client ‚Äî Build & Lint
    needs: changes
    if: needs.changes.outputs.client == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: client/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: üîç TypeScript type check
        run: npx tsc --noEmit --pretty
        continue-on-error: true

      - name: üßπ Lint
        run: npx eslint src/ --ext .js,.jsx,.ts,.tsx --format stylish --max-warnings 50
        continue-on-error: true

      - name: üèóÔ∏è Build
        run: npm run build
        env:
          CI: true
          REACT_APP_API_URL: http://localhost/api
          REACT_APP_WEBSOCKET_URL: ws://localhost

      - name: üìä Bundle size report
        run: |
          echo "### üì¶ Client Bundle Size" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          du -sh build/ 2>/dev/null || echo "No build output"
          find build/static -name '*.js' -exec du -sh {} \; 2>/dev/null | sort -rh | head -10
          find build/static -name '*.css' -exec du -sh {} \; 2>/dev/null | sort -rh | head -5
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Also write to summary
          {
            echo "| Asset | Size |"
            echo "|-------|------|"
            find build/static -name '*.js' -exec du -sh {} \; 2>/dev/null | sort -rh | head -10 | while read size file; do
              echo "| \`$(basename $file)\` | $size |"
            done
            find build/static -name '*.css' -exec du -sh {} \; 2>/dev/null | sort -rh | head -5 | while read size file; do
              echo "| \`$(basename $file)\` | $size |"
            done
          } >> $GITHUB_STEP_SUMMARY

      - name: üì§ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-build
          path: client/build
          retention-days: 7

  client-test:
    name: üß™ Client ‚Äî Tests
    needs: changes
    if: needs.changes.outputs.client == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: client/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: üß™ Run tests
        run: npx react-scripts test --ci --coverage --watchAll=false --reporters=default --reporters=jest-junit 2>/dev/null || echo "No tests found ‚Äî skipping"
        env:
          CI: true
          JEST_JUNIT_OUTPUT_DIR: ./reports
          JEST_JUNIT_OUTPUT_NAME: junit.xml

      - name: üìä Test results summary
        if: always()
        run: |
          echo "### üß™ Client Test Results" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/junit.xml ]; then
            echo "‚úÖ Tests executed ‚Äî see artifacts for details" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No test files found. Consider adding tests to improve coverage." >> $GITHUB_STEP_SUMMARY
          fi

  # ‚îÄ‚îÄ Server Pipeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  server-build:
    name: ‚öôÔ∏è Server ‚Äî Validate & Lint
    needs: changes
    if: needs.changes.outputs.server == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üßπ Lint
        run: npx eslint . --ext .js,.mjs --max-warnings 50 2>/dev/null || echo "No ESLint config found ‚Äî skipping"
        continue-on-error: true

      - name: ‚úÖ Syntax validation
        run: node --check server.js && echo "‚úÖ server.js syntax OK"

      - name: üìã Dependency audit
        run: |
          echo "### ‚öôÔ∏è Server Dependency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total deps | $(npm ls --all --json 2>/dev/null | jq '[.. | .version? // empty] | length') |" >> $GITHUB_STEP_SUMMARY
          echo "| Direct deps | $(jq '.dependencies | length' package.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| Node version | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY

  # ‚îÄ‚îÄ Security Scanning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üîí Client audit
        working-directory: client
        run: |
          npm ci --legacy-peer-deps
          npm audit --omit=dev --audit-level=high 2>&1 || true
        continue-on-error: true

      - name: üîí Server audit
        working-directory: server
        run: |
          npm ci
          npm audit --omit=dev --audit-level=high 2>&1 || true
        continue-on-error: true

      - name: üìä Security summary
        run: |
          echo "### üîí Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Client:**" >> $GITHUB_STEP_SUMMARY
          cd client && npm audit --omit=dev 2>&1 | tail -5 >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:**" >> $GITHUB_STEP_SUMMARY
          cd ../server && npm audit --omit=dev 2>&1 | tail -5 >> $GITHUB_STEP_SUMMARY || true

  # ‚îÄ‚îÄ Docker Build ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  docker:
    name: üê≥ Docker Build
    needs: [changes, client-build, server-build]
    if: always() && (needs.changes.outputs.docker == 'true' || github.event_name == 'push')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [client, server]
    steps:
      - uses: actions/checkout@v4

      - name: üê≥ Build ${{ matrix.component }} image
        run: |
          docker build \
            --tag runwatch-${{ matrix.component }}:ci-${{ github.sha }} \
            --tag runwatch-${{ matrix.component }}:latest \
            --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            ./${{ matrix.component }}

      - name: üìè Image size
        run: |
          SIZE=$(docker image inspect runwatch-${{ matrix.component }}:latest --format '{{.Size}}' | numfmt --to=iec-i 2>/dev/null || docker image inspect runwatch-${{ matrix.component }}:latest --format '{{.Size}}')
          echo "### üê≥ ${{ matrix.component }} Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "Size: **${SIZE}**" >> $GITHUB_STEP_SUMMARY

  # ‚îÄ‚îÄ Integration Test (docker-compose) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  integration:
    name: üîó Integration ‚Äî Docker Compose
    needs: docker
    if: always() && needs.docker.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üîó Validate docker-compose
        run: docker compose config -q

      - name: üöÄ Start services
        run: |
          # Create minimal .env for CI
          cat > .env <<EOF
          GITHUB_APP_ID=12345
          GITHUB_APP_PRIVATE_KEY=test
          GITHUB_WEBHOOK_SECRET=test
          MONGODB_URI=mongodb://admin:password@mongo:27017/runwatch?authSource=admin
          MONGO_INITDB_ROOT_USERNAME=admin
          MONGO_INITDB_ROOT_PASSWORD=password
          MONGO_INITDB_DATABASE=runwatch
          PORT=5001
          NODE_ENV=production
          ALLOWED_ORIGINS=http://localhost
          RATE_LIMIT_WINDOW_MS=60000
          RATE_LIMIT_MAX_REQUESTS=100
          EOF
          docker compose up -d --build --wait --wait-timeout 60 2>&1 || true

      - name: üè• Health checks
        run: |
          echo "### üîó Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Wait for services
          sleep 10

          # Check container status
          echo "**Container Status:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker compose ps >> $GITHUB_STEP_SUMMARY 2>&1
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Test server health
          if curl -sf http://localhost:5001/api/health --max-time 10 2>/dev/null; then
            echo "‚úÖ Server health check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Server health endpoint not responding (may need /api/health route)" >> $GITHUB_STEP_SUMMARY
          fi

          # Test client
          if curl -sf http://localhost --max-time 10 2>/dev/null | head -1 | grep -q "html"; then
            echo "‚úÖ Client serving HTML" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Client not responding on port 80" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üìã Logs on failure
        if: failure()
        run: docker compose logs --tail=50

      - name: üßπ Cleanup
        if: always()
        run: docker compose down -v

  # ‚îÄ‚îÄ Summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ci-status:
    name: ‚úÖ CI Status
    needs: [client-build, client-test, server-build, security, docker, integration]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: üìä Pipeline Summary
        run: |
          echo "## üèÅ RunWatch CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üñ•Ô∏è Client Build | \`${{ needs.client-build.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üß™ Client Tests | \`${{ needs.client-test.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚öôÔ∏è Server Validate | \`${{ needs.server-build.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üîí Security Audit | \`${{ needs.security.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üê≥ Docker Build | \`${{ needs.docker.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| üîó Integration | \`${{ needs.integration.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: **${{ github.actor }}** via \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Fail if critical jobs failed
        if: |
          needs.client-build.result == 'failure' ||
          needs.server-build.result == 'failure'
        run: exit 1
